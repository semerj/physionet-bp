# Continuous Blood Pressure Prediction

### Summary

Supervised machine learning to predict whether an ICU patient's bloop pressure is at rest, received a vasoconstrictor, or received a vasodilator using three forms of biosensor data:

* ECG (electrocardiography): the bio-potential generated by electrical signals that control the expansion and contraction of heart chambers
* Fingertip PPG (photoplethysmography): light-based technology to sense the rate of blood flow as controlled by the heartâ€™s pumping action
* Bioimpedence data

Continuous arterial blood pressure (ABP) waveforms will be converted into our true "labels".

Import caveats from the [MIMIC II Waveform Database summary](https://physionet.org/physiobank/database/mimic2wdb/):

> Recorded waveforms and numerics vary depending on choices made by the ICU staff. Waveforms almost always include one or more ECG signals, and often include continuous arterial blood pressure (ABP) waveforms, fingertip photoplethysmogram (PPG) signals, and respiration, with additional waveforms (up to 8 simultaneously) as available. Numerics typically include heart and respiration rates, SpO2, and systolic, mean, and diastolic blood pressure, together with others as available. Recording lengths also vary; most are a few days in duration, but some are shorter and others are several weeks long. 

**Major datasets:**

* [MIMIC II Clinical database](https://physionet.org/works/MIMICIIClinicalDatabase/files/) (login required)
* [MIMIC II Waveform Matched Subset database](https://www.physionet.org/physiobank/database/mimic2wdb/matched/) (550 GB)

For each of the 3000+ patients, there are multiple text files. 

**Files of interest:**

* `MEDEVENTS`
* `ADDITIVES`
* `PEO_MED`
* `POE_ORDER`
* `DEMOGRAPHIC_DETAIL`

**Medications of interest:**

1. vasodilators:
    * nitroglycerine-k (121)
    * nitroglycerine (49)
    * nitroprussid (50)
2. vasoconstrictors: 
    * neosynephrine-k (128)
    * epinephrine-k (119)
    * neosyneprine (127)
    * epinephrine drip (309)
    * dobutamine (42)
    * epinephrine (44)

### Select Patients Treated with vasodilators & vasoconstrictors from MIMIC II Clinical Database

It's better to search the name of all the interested drugs in the file `POE_MED` or `POE_ORDER`. In the `MEDEVENTS` file, the drugs are represented by the codes in the parenthesis.

We can merge `POE_MED` with `POE_ORDER` to get the duration and dose of nitroglycerine in one file, after we decide to pick the record of specific patient.

### Merge clinical data with MIMIC II Waveform Matched Subset

The next task is to merge the selected clinical data with the MIMIC II Waveform Matched Subset. This is free access, but very large if we wish to download all. The description page has some codes for downloading. 

To visualize the waveform data, you can go to [PhysioNet ATM](https://www.physionet.org/cgi-bin/atm/ATM) and go to the Input database drop down menu and click MIMIC II Waveform Matched Subset (`mimic2wdb/matched`) and choose the samples in the below drop down menu. To merge the subset with the clinical data, we need to determine the subject_id that is shared by both. We also need to align the time of different data files.

## Converting Waveform Data

After identifying a patient that received a vasoconstrictor/vasodilator, download one of their [segments](https://www.physionet.org/physiobank/database/mimic2wdb/matched/s00177/3555290_0001.dat) and its associated [header](https://www.physionet.org/physiobank/database/mimic2wdb/matched/s00177/3555290_0001.hea), e.g. record 00177 ([full data](https://www.physionet.org/physiobank/database/mimic2wdb/matched/s00177/)). More [info](https://physionet.org/physiobank/database/mimic2wdb/):

> In almost all cases, the waveform records are comprised of multiple segments, each of which can be read as a separate record. Each segment contains an uninterrupted recording of a set of simultaneously observed signals, and the signal gains do not change at any time during the segment. Whenever the ICU staff changed the signals being monitored or adjusted the amplitude of a signal being monitored, this event was recorded in the raw data dump, and a new segment begins at that time. 

> Each composite waveform record includes a list of the segments that comprise it in its **master header file**. The list begins on the second line of the master header with a **layout header file** that specifies all of the signals that are observed in any segment belonging to the record. Each segment has its own **header file** and (except for the layout header) a matching (binary) **signal (.dat) file**. Occasionally, the monitor may be disconnected entirely for a short time; these intervals are recorded as gaps in the master header file, but there are no header or signal files corresponding to gaps. 

#### Install WFDB toolkit

To convert the signal data, we'll need to install the [WFDB toolkit](https://physionet.org/physiotools/wfdb-linux-quick-start.shtml). (Physionet also provides  additional software for [analysis](https://physionet.org/physiotools/software-index.shtml).) The Github repo should contain a Vagrantfile that will create an Ubuntu image and automatically install the requirements for the WFDB toolkit. Start vagrant:

```sh
$ vagrant up
$ vagrant ssh
```

#### 1. Matlab (`.mat`)

Use `wfdb2mat` to convert into Matlab's native format ([manual](https://www.physionet.org/physiotools/wag/wfdb2m-1.htm)). You can then import the `.mat` file into Python using `scipy.io.loadmat`.

```sh
# need 3555290_0001.dat and 3555290_0001.hea in same directory
$ wfdb2mat -r 3555290_0001
# this outputs 3555290_0001m.hea and 3555290_0001m.mat, which can be read into Python
```

#### 2. CSV (very large file size compared to Matlab format)

Use `rdsamp` with the `-c` flag to convert the data into CSV format ([manual](https://physionet.org/physiotools/wag/rdsamp-1.htm)).

```sh
$ rdsamp -r 3555290_0001 -pd -c > s00177.csv
```